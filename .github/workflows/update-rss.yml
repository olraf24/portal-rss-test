// ZASTÄ„P obie stare funkcje (enhanceTitleWithGroq i enhanceDescriptionWithGroq) tÄ… jednÄ…:

async function enhanceTitleAndDescriptionWithGroq(originalTitle, originalDescription) {
  const prompt = `ZADANIE: Przepisz tytuÅ‚ i opis artykuÅ‚u informacyjnego.

WYMAGANIA DLA TYTUÅU:
- UsuÅ„ clickbaitowe elementy
- Zachowaj wszystkie fakty
- Napisz w stylu informacyjnym, nie sensacyjnym  
- Bez cudzysÅ‚owÃ³w i wykrzyknikÃ³w
- Maksymalnie 80 znakÃ³w
- Precyzyjny i merytoryczny ton

WYMAGANIA DLA OPISU:
- PrzeksztaÅ‚Ä‡ w listÄ™ punktowÄ…
- Wypunktuj WSZYSTKIE informacje z opisu
- KAÅ»DY PUNKT W OSOBNEJ LINII
- Zacznij kaÅ¼dy punkt od: â€¢
- Zachowaj wszystkie szczegÃ³Å‚y (liczby, miejsca, osoby)
- NIE DUPLIKUJ informacji z tytuÅ‚u
- Nie dodawaj wÅ‚asnych komentarzy

ORYGINALNY TYTUÅ:
${originalTitle}

ORYGINALNY OPIS:
${originalDescription}

ODPOWIEDÅ¹ W FORMACIE JSON:
{
  "title": "przepisany neutralny tytuÅ‚",
  "description": "â€¢ Pierwszy punkt\\nâ€¢ Drugi punkt\\nâ€¢ Trzeci punkt"
}

WAÅ»NE: Odpowiedz TYLKO kodem JSON, bez Å¼adnych innych tekstÃ³w!`;

  const requestData = JSON.stringify({
    messages: [
      {
        role: "system",
        content: "JesteÅ› redaktorem prasowym specjalizujÄ…cym siÄ™ w pisaniu neutralnych, informacyjnych tytuÅ‚Ã³w i strukturyzowaniu informacji w listy punktowe. Zawsze odpowiadasz tylko kodem JSON."
      },
      {
        role: "user",
        content: prompt
      }
    ],
    model: "llama-3.3-70b-versatile",
    temperature: 0.2,
    max_tokens: 600,
    top_p: 0.9
  });

  return new Promise((resolve, reject) => {
    const options = {
      hostname: 'api.groq.com',
      path: '/openai/v1/chat/completions',
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + GROQ_API_KEY,
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(requestData)
      },
      timeout: 15000
    };

    const req = https.request(options, (res) => {
      // Sprawdzenie rate limit headers
      console.log('=== GROQ RATE LIMIT INFO ===');
      console.log('Status:', res.statusCode);
      console.log('TPM remaining:', res.headers['x-ratelimit-remaining-tokens']);
      console.log('RPM remaining:', res.headers['x-ratelimit-remaining-requests']);
      
      if (res.statusCode === 429) {
        const retryAfter = res.headers['retry-after'];
        console.log('ğŸš¨ RATE LIMIT EXCEEDED! Retry after:', retryAfter, 'seconds');
        resolve({
          title: originalTitle,
          description: originalDescription,
          rateLimitHit: true
        });
        return;
      }

      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => {
        try {
          if (res.statusCode !== 200) {
            console.log('Groq API error for combined processing:', res.statusCode);
            resolve({
              title: originalTitle,
              description: originalDescription,
              error: true
            });
            return;
          }
          
          const response = JSON.parse(data);
          let enhancedText = response.choices[0].message.content.trim();
          
          // UsuÅ„ ewentualne markdown backticks
          enhancedText = enhancedText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          
          console.log('Raw Groq response:', enhancedText);
          
          // Parsuj JSON odpowiedÅº
          const enhancedData = JSON.parse(enhancedText);
          
          console.log('Enhanced title:', enhancedData.title);
          console.log('Enhanced description:', enhancedData.description.substring(0, 100) + '...');
          
          // SprawdÅº czy siÄ™ zmieniÅ‚o
          const titleChanged = enhancedData.title !== originalTitle;
          const descChanged = enhancedData.description !== originalDescription;
          
          console.log(`Title changed: ${titleChanged ? 'YES' : 'NO'}`);
          console.log(`Description changed: ${descChanged ? 'YES' : 'NO'}`);
          
          resolve({
            title: enhancedData.title || originalTitle,
            description: enhancedData.description || originalDescription,
            success: true
          });
          
        } catch (error) {
          console.log('Combined processing error:', error);
          console.log('Raw response that failed to parse:', data);
          resolve({
            title: originalTitle,
            description: originalDescription,
            parseError: true
          });
        }
      });
    });

    req.on('error', (error) => {
      console.log('Request error:', error);
      resolve({
        title: originalTitle,
        description: originalDescription,
        networkError: true
      });
    });
    
    req.on('timeout', () => {
      console.log('Request timeout');
      req.destroy();
      resolve({
        title: originalTitle,
        description: originalDescription,
        timeout: true
      });
    });

    req.setTimeout(15000);
    req.write(requestData);
    req.end();
  });
}

// ZMIEÅƒ gÅ‚Ã³wnÄ… pÄ™tlÄ™ w funkcji main():
// ZnajdÅº tÄ™ czÄ™Å›Ä‡ kodu i zastÄ…p jÄ…:

// Ulepszanie opisÃ³w i tytuÅ‚Ã³w z Groq (sekwencyjnie z opÃ³Åºnieniem)
let totalRequests = 0;
let successfulRequests = 0;
let rateLimitErrors = 0;

for (let i = 0; i < articles.length; i++) {
  const article = articles[i];
  
  if (article.description && article.description !== 'Brak opisu') {
    console.log(`\\n=== PRZETWARZANIE ${i + 1}/${articles.length} ===`);
    console.log(`Oryginalny tytuÅ‚: ${article.title}`);
    console.log(`Oryginalny opis: ${article.description.substring(0, 100)}...`);
    
    totalRequests++;
    console.log('Przetwarzanie tytuÅ‚u i opisu jednoczeÅ›nie...');
    
    // JEDEN REQUEST zamiast dwÃ³ch
    const enhanced = await enhanceTitleAndDescriptionWithGroq(
      article.title,
      article.description
    );
    
    if (enhanced.rateLimitHit) {
      rateLimitErrors++;
    } else if (enhanced.success) {
      successfulRequests++;
    }
    
    articles[i].originalTitle = article.title;
    articles[i].originalDescription = article.description;
    articles[i].title = enhanced.title;
    articles[i].description = enhanced.description;
    
    console.log(`Nowy tytuÅ‚: ${enhanced.title}`);
    console.log(`Nowy opis: ${enhanced.description.substring(0, 100)}...`);
    
    // OpÃ³Åºnienie miÄ™dzy artykuÅ‚ami
    if (i < articles.length - 1) {
      console.log('Czekam 3 sekundy...');
      await delay(3000);
    }
  } else {
    console.log(`Pomijam artykuÅ‚ ${i + 1} - brak opisu`);
  }
}

console.log('\\n=== PODSUMOWANIE GROQ API ===');
console.log('ÅÄ…czne requesty:', totalRequests);
console.log('Udane requesty:', successfulRequests);
console.log('Rate limit errors:', rateLimitErrors);
console.log('Success rate:', totalRequests > 0 ? Math.round((successfulRequests/totalRequests)*100) + '%' : '0%');
